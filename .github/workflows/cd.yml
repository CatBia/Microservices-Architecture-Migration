name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      service_name:
        description: 'Service to deploy (leave empty for all)'
        required: false
        type: string

jobs:
  # Deploy to Development
  deploy-dev:
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    uses: ./.github/workflows/reusable/deploy-kubernetes.yml
    with:
      environment: dev
      service_name: ${{ github.event.inputs.service_name || 'api-gateway' }}
      namespace: movister
      image_tag: ${{ github.sha }}
      eks_cluster_name: movister-dev
      aws_region: us-east-1
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Deploy to Staging
  deploy-staging:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    needs: [deploy-dev]
    uses: ./.github/workflows/reusable/deploy-kubernetes.yml
    with:
      environment: staging
      service_name: ${{ github.event.inputs.service_name || 'api-gateway' }}
      namespace: movister
      image_tag: ${{ github.sha }}
      eks_cluster_name: movister-staging
      aws_region: us-east-1
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Deploy to Production
  deploy-production:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    needs: [deploy-staging]
    uses: ./.github/workflows/reusable/deploy-kubernetes.yml
    with:
      environment: production
      service_name: ${{ github.event.inputs.service_name || 'api-gateway' }}
      namespace: movister
      image_tag: ${{ github.sha }}
      eks_cluster_name: movister-production
      aws_region: us-east-1
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

